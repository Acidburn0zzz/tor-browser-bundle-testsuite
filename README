Tor Browser Bundle test suite
=============================

Installation
------------

To run the test suite, you need perl and the following perl modules:

  Cwd
  Data::Dump
  Digest::SHA
  File::Copy
  File::Path
  File::Slurp
  File::Spec
  File::Temp
  FindBin
  Getopt::Long
  IO::CaptureOutput
  IO::Socket::INET
  Image::Magick
  JSON
  LWP::UserAgent
  LWP::Protocol::https
  Template
  YAML

If you are using Fedora or other yum based distribution, you can install
each module with 'yum install perl(ModuleName)'.

The test suite also requires mozmill and python selenium, which we install
using a virtualenv. You can use the 'setup' script to install them into
a virtualenv:

  $ ./setup

If you want to reinstall the virtualenv used, remove the 'virtualenv'
directory and run 'setup' again.

Unless you are using the '--no-xvfb' option, all tests will be run in
a virtual framebuffer with xvfb, so you need to have xvfb installed.


Usage
-----

 $ ./tbb-testsuite [options] <tbb-file>...

The <tbb-file> can be:

- the path to a tbb tarball file.

- the path to a sha256sum file. In which case all tarballs listed in the
  sha256sum and compatible with the current platform will be tested.

- the URL of a tbb tarball, which will be downloaded before being tested.

- the URL of a sha256sum file, which will be downloaded. The gpg signature
  from file sha256sum.asc will also be downloaded and checked with the
  keyring selected with the --keyring option, unless the --no-gpgcheck
  option is used. All the tarballs listed in the sha256sum and compatible
  with the current platform will be downloaded, have their checksum
  checked and will be tested.


Available options
-----------------

--action=<name>
        Select the action to be done. The default is to run the tests.
        See the section about actions for details.

--config=<file>
        Select a configuration file. See the section about Configuration
        Files below.

--no-gpgcheck
        Disable gpg check when downloading a sha256sum.txt file.

--keyring=<file>
        Name of the keyring file used to check the gpg signature of a
        downloaded sha256sum.txt file. If the file is not an absolute
        path, then it is relative to the keyring directory.

--download-dir=<directory>
        The directory where to store the files downloaded when a URL is
        given rather than a local path. If the file already exists in
        this directory, it is not downloaded again. If this option is
        not given, the files are downloaded in a temporary directory
        which is removed at the end of the tests.

--no-mozmill
        Don't run mozmill tests.

--no-selenium
        Don't run the Selenium tests.

--no-start-tor
        Don't start a tor daemon. If you use this option, you should
        already have a tor daemon running.

--tor-control-port=<port>
        Select the tor control port number. Default is 9551.

--tor-socks-port=<port>
        Select the tor socks port. Default is 9550.

--reports-dir=<directory>
        Directory where the tests reports are saved.

--name=<name>
        The name of the tests run. This is used as directory name to
        save the results inside the reports-dir. If not set, a random
        name is used.

--virtualenv=<directory>
        Path to the virtualenv where selenium and mozmill are installed.
        The default is the 'virtualenv' directory created by the 'setup'
        script.

--no-xvfb
        Don't run the tests using a virtual frame buffer X server.

--resolution=<resolution>
        When using xvfb, this sets the default resolution. The default
        is 1024x768.


Configuration Files
-------------------

In addition to setting options using command line arguments, it is
possible to set options using a configuration file and the --config
option. If the path given to the --config option is relative, it is
expected to be in the config directory.

The configuration file is a perl script which when evaluated should
return a hash containing the configuration. The options set by the
default configuration and command line arguments are available to this
script in the $option hash reference.


Selecting action
----------------

The --action option can be used to select the action to be done. The
following actions are available:

  run_tests::
        Run the tests, make a report, and update the reports index page.
        This is the default action.

  reports_index::
        Create an index page listing the tests reports.

